# Test info

- Name: Civic Auth Applications >> should complete full login and logout flow with basepath
- Location: /__w/civic-auth-examples/civic-auth-examples/packages/e2e/playwright/tests/civic-auth/basePath/nextjs-login.spec.ts:10:7

# Error details

```
Error: locator.waitFor: Error: strict mode violation: locator('#civic-auth-iframe') resolved to 2 elements:
    1) <iframe scrolling="no" frameborder="0" seamless="seamless" id="civic-auth-iframe" allowfullscreen="true" data-testid="civic-auth-iframe-with-resizer" allow="camera; screen-wake-lock; publickey-credentials-get *; publickey-credentials-create *" src="http://localhost:3000/demo/api/auth/login?state=eyJ1dWlkIjoiMGVkNDY4M2YtNWUyNS00MmY3LWJlZWMtMGQxODdkZDA2ODViIiwiZGlzcGxheU1vZGUiOiJpZnJhbWUiLCJpZnJhbWVEaXNwbGF5TW9kZSI6Im1vZGFsIiwiZnJhbWV3b3JrIjoibmV4dGpzIiwic2RrVmVyc2lvbiI6IkBjaXZpYy9hdXRoOjAuMTAuMC1iZXRhL…></iframe> aka locator('[data-testid="civic-auth-iframe-with-resizer"]').first()
    2) <iframe scrolling="no" frameborder="0" seamless="seamless" id="civic-auth-iframe" allowfullscreen="true" data-testid="civic-auth-iframe-with-resizer" allow="camera; screen-wake-lock; publickey-credentials-get *; publickey-credentials-create *" src="http://localhost:3000/demo/api/auth/login?state=eyJ1dWlkIjoiNWJjMmExYzctYzE4OC00YTQ1LTg4ZTUtNzExMmMzODJiNTkxIiwiZGlzcGxheU1vZGUiOiJpZnJhbWUiLCJpZnJhbWVEaXNwbGF5TW9kZSI6Im1vZGFsIiwiZnJhbWV3b3JrIjoibmV4dGpzIiwic2RrVmVyc2lvbiI6IkBjaXZpYy9hdXRoOjAuMTAuMC1iZXRhL…></iframe> aka locator('[data-testid="civic-auth-iframe-with-resizer"]').nth(1)

Call log:
  - waiting for locator('#civic-auth-iframe').contentFrame().locator('[data-testid*="civic-login"]').first() to be visible

    at /__w/civic-auth-examples/civic-auth-examples/packages/e2e/playwright/tests/civic-auth/basePath/nextjs-login.spec.ts:56:65
```

# Page snapshot

```yaml
- main:
  - heading "Civic Auth (NextJS)" [level=1]
  - button "Signing in..."
  - button "Sign in (Custom)"
- button "Open Next.js Dev Tools":
  - img
- alert
- iframe
- img
- button "Close":
  - img
```

# Test source

```ts
   1 | import { test, expect } from '@playwright/test';
   2 | import { allure } from 'allure-playwright';
   3 |
   4 | test.describe('Civic Auth Applications', () => {
   5 |   test.beforeEach(async ({ page }) => {
   6 |     await allure.epic('Civic Auth Applications');
   7 |     await allure.suite('Login Basepath');
   8 |     await allure.feature('Next.js Login (BasePath)');
   9 |   });
   10 |   test('should complete full login and logout flow with basepath', async ({ page, browserName }) => {
   11 |     // Configure test to be more resilient
   12 |     test.setTimeout(120000); // Increase timeout to 2 minutes
   13 |     
   14 |     // Fix basePath callback routing issue - redirect /api/auth/callback to /demo/api/auth/callback
   15 |     await page.route('**/api/auth/callback*', async (route) => {
   16 |       const url = new URL(route.request().url());
   17 |       const redirectUrl = `http://localhost:3000/demo/api/auth/callback${url.search}`;
   18 |       await route.continue({ url: redirectUrl });
   19 |     });
   20 |
   21 |     // Open the app home page with basepath
   22 |     await page.goto('http://localhost:3000/demo');
   23 |
   24 |     // Wait for the page to fully load with all UI elements
   25 |     await page.waitForLoadState('networkidle');
   26 |     await page.waitForLoadState('domcontentloaded');
   27 |     
   28 |     // Wait for the UserButton to be visible (the one that says "Sign in")
   29 |     await page.waitForSelector('button', { timeout: 10000 });
   30 |     
   31 |     // Click the UserButton "Sign in" button (first button, not the custom one)
   32 |     await page.locator('button').filter({ hasText: /^Sign in$/ }).click();
   33 |     
   34 |     // Wait for iframe to appear and load
   35 |     await page.waitForSelector('#civic-auth-iframe', { timeout: 30000 });
   36 |     
   37 |     // Click log in with dummy in the iframe
   38 |     const frame = page.frameLocator('#civic-auth-iframe');
   39 |     
   40 |     // Try to wait for the frame to load completely first
   41 |     await frame.locator('body').waitFor({ timeout: 30000 });
   42 |     
   43 |     // Wait for the login UI to fully load (not just the loading spinner)
   44 |     try {
   45 |       const loadingElement = frame.locator('#civic-login-app-loading');
   46 |       const isLoadingVisible = await loadingElement.isVisible({ timeout: 5000 }).catch(() => false);
   47 |       
   48 |       if (isLoadingVisible) {
   49 |         await loadingElement.waitFor({ state: 'hidden', timeout: 45000 });
   50 |       }
   51 |     } catch (error) {
   52 |       // Loading element might not exist, that's ok
   53 |     }
   54 |     
   55 |     // Wait for login elements to appear
>  56 |     await frame.locator('[data-testid*="civic-login"]').first().waitFor({ timeout: 30000 });
      |                                                                 ^ Error: locator.waitFor: Error: strict mode violation: locator('#civic-auth-iframe') resolved to 2 elements:
   57 |     
   58 |     const dummyButton = frame.locator('[data-testid="civic-login-oidc-button-dummy"]');
   59 |     await dummyButton.waitFor({ state: 'visible', timeout: 30000 });
   60 |     
   61 |     // Add a small delay to ensure button is fully interactive
   62 |     await page.waitForTimeout(1000);
   63 |     
   64 |     // Click the dummy button
   65 |     await dummyButton.click({ timeout: 20000 });
   66 |     
   67 |     // Wait for the iframe to be gone (indicating login is complete)
   68 |     await page.waitForSelector('#civic-auth-iframe', { state: 'hidden', timeout: 60000 });
   69 |     
   70 |     // Wait a bit for the auth state to update
   71 |     await page.waitForTimeout(2000);
   72 |   
   73 |     // Confirm logged in state by checking for Ghost button in dropdown
   74 |     const ghostButtonLocator = page.locator('#civic-dropdown-container').locator('button:has-text("Ghost")');
   75 |     await expect(ghostButtonLocator).toBeVisible({ timeout: 20000 });
   76 |     
   77 |     // Verify custom loginSuccessUrl is not loaded (should still be on basepath)
   78 |     await expect(page.url()).not.toContain('loginSuccessUrl');
   79 |     await expect(page.url()).toContain('/demo');
   80 |
   81 |     // Capture essential cookies after login
   82 |     const cookiesAfterLogin = await page.context().cookies();
   83 |     const authCookies = cookiesAfterLogin.filter(cookie => 
   84 |       cookie.name.includes('civic-auth') || 
   85 |       cookie.name.includes('access_token') || 
   86 |       cookie.name.includes('refresh_token') ||
   87 |       cookie.name.includes('id_token') ||
   88 |       cookie.name.includes('session')
   89 |     );
   90 |     
   91 |     // Verify we have essential auth cookies
   92 |     expect(authCookies.length).toBeGreaterThan(0);
   93 |
   94 |     // Click the Ghost button in dropdown
   95 |     const ghostButton = page.locator('#civic-dropdown-container').locator('button:has-text("Ghost")');
   96 |     await ghostButton.waitFor({ state: 'visible', timeout: 10000 });
   97 |     await ghostButton.click();
   98 |
   99 |     // Click the logout button
  100 |     const logoutButton = page.locator('#civic-dropdown-container').locator('button:has-text("Logout")');
  101 |     await logoutButton.waitFor({ state: 'visible', timeout: 10000 });
  102 |     await logoutButton.click();
  103 |     
  104 |     // Confirm successful logout
  105 |     await expect(page.locator('#civic-dropdown-container').locator('button:has-text("Ghost")')).not.toBeVisible();
  106 |     
  107 |     // Verify essential cookies are deleted after logout
  108 |     const cookiesAfterLogout = await page.context().cookies();
  109 |     const remainingAuthCookies = cookiesAfterLogout.filter(cookie => 
  110 |       cookie.name.includes('civic-auth') || 
  111 |       cookie.name.includes('access_token') || 
  112 |       cookie.name.includes('refresh_token') ||
  113 |       cookie.name.includes('id_token') ||
  114 |       cookie.name.includes('session')
  115 |     );
  116 |     
  117 |     // Assert that essential auth cookies have been deleted
  118 |     expect(remainingAuthCookies.length).toBe(0);
  119 |     
  120 |     // Additional verification: try to access a protected route to ensure session is cleared
  121 |     await page.goto('http://localhost:3000/demo');
  122 |     await page.waitForLoadState('networkidle');
  123 |     
  124 |     // Should be back to logged-out state (Sign In button visible, Ghost button not visible)
  125 |     await expect(page.locator('button').filter({ hasText: /^Sign in$/ })).toBeVisible({ timeout: 10000 });
  126 |     await expect(page.locator('#civic-dropdown-container').locator('button:has-text("Ghost")')).not.toBeVisible();
  127 |   });
  128 | });
  129 |
```