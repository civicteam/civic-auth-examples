name: Civic Auth Web3 Example Apps - E2E Tests (Start Mode)

on:
  schedule:
    - cron: '0 1 * * *'  # Run daily at midnight UTC
  workflow_dispatch:
    
jobs:
  check-version:
    uses: ./.github/workflows/check-versions.yml

  typecheck:
    uses: ./.github/workflows/typecheck.yml

  job-solana-next14-no-wa-example-app:
    name: "Solana Next.js 14 No Wallet Adapter example app"
    needs: [check-version, typecheck]
    uses: ./.github/workflows/test-example-app-playwright.yml
    with:
      project-path: packages/civic-auth-web3/solana/next14-no-wallet-adapter
      playwright-spec: "playwright/tests/civic-auth-web3/login/solana-next14-no-wa-login.spec.ts"
      dev-command: "yarn start"
      job-name: "üåê Solana Next.js 14 No WA (Login)"
      workflow-identifier: "start-mode"
      allure-parent-suite: "Web3 Start Mode"
    secrets: inherit

  job-solana-next15-no-wa-example-app:
    name: "Solana Next.js 15 No Wallet Adapter example app"
    needs: [check-version, typecheck]
    uses: ./.github/workflows/test-example-app-playwright.yml
    with:
      project-path: packages/civic-auth-web3/solana/next15-no-wallet-adapter
      playwright-spec: "playwright/tests/civic-auth-web3/login/solana-next15-no-wa-login.spec.ts"
      dev-command: "yarn start"
      job-name: "üåê Solana Next.js 15 No WA (Login)"
      workflow-identifier: "start-mode"
      allure-parent-suite: "Web3 Start Mode"
    secrets: inherit

  # SKIPPED: Turbopack wallet adapter test - Civic wallet not appearing in wallet selection modal
  # Issue: The Solana Wallet Adapter auto-discovery mechanism for Civic wallet is not working with Turbopack
  # This appears to be a limitation in how the wallet adapter's discovery works with Turbopack's bundling
  # job-solana-next15-turbopack-no-wa-example-app:
  #   name: "Solana Next.js 15 Turbopack No Wallet Adapter example app"
  #   needs: [check-version, typecheck]
  #   uses: ./.github/workflows/test-example-app-playwright.yml
  #   with:
  #     project-path: packages/civic-auth-web3/solana/next15-no-wallet-adapter
  #     playwright-spec: "playwright/tests/civic-auth-web3/login/solana-next15-turbopack-no-wa-login.spec.ts"
  #     build-command: "yarn build"
  #     dev-command: "yarn start-turbopack"
  #     job-name: "üåê Solana Next.js 15 Turbopack No WA (Login)"
  #     workflow-identifier: "start-mode"
  #     allure-parent-suite: "Web3 Start Mode"
  #   secrets: inherit

  job-solana-vite-no-wa-example-app:
    name: "Solana Vite No Wallet Adapter example app"
    needs: [check-version, typecheck]
    uses: ./.github/workflows/test-example-app-playwright.yml
    with:
      project-path: packages/civic-auth-web3/solana/vite-no-wallet-adapter
      playwright-spec: "playwright/tests/civic-auth-web3/login/solana-vite-no-wa-login.spec.ts"
      dev-command: "yarn start"
      job-name: "üåê Solana Vite No WA (Login)"
      workflow-identifier: "start-mode"
      allure-parent-suite: "Web3 Start Mode"
    secrets: inherit

  job-solana-next14-wa-example-app:
    name: "Solana Next.js 14 Wallet Adapter example app"
    needs: [check-version, typecheck]
    uses: ./.github/workflows/test-example-app-playwright.yml
    with:
      project-path: packages/civic-auth-web3/solana/next14-wallet-adapter
      playwright-spec: "playwright/tests/civic-auth-web3/login/solana-next14-wa-login.spec.ts"
      dev-command: "yarn start"
      job-name: "üåê Solana Next.js 14 WA (Login)"
      workflow-identifier: "start-mode"
      allure-parent-suite: "Web3 Start Mode"
    secrets: inherit

  job-solana-next15-wa-example-app:
    name: "Solana Next.js 15 Wallet Adapter example app"
    needs: [check-version, typecheck]
    uses: ./.github/workflows/test-example-app-playwright.yml
    with:
      project-path: packages/civic-auth-web3/solana/next15-wallet-adapter
      playwright-spec: "playwright/tests/civic-auth-web3/login/solana-next15-wa-login.spec.ts"
      dev-command: "yarn start"
      job-name: "üåê Solana Next.js 15 WA (Login)"
      workflow-identifier: "start-mode"
      allure-parent-suite: "Web3 Start Mode"
    secrets: inherit

  # SKIPPED: Turbopack wallet adapter test - Civic wallet not appearing in wallet selection modal
  # Issue: The Solana Wallet Adapter auto-discovery mechanism for Civic wallet is not working with Turbopack
  # This appears to be a limitation in how the wallet adapter's discovery works with Turbopack's bundling
  # The non-wallet-adapter turbopack test (job-solana-next15-turbopack-no-wa-example-app) works correctly
  # job-solana-next15-turbopack-wa-example-app:
  #   name: "Solana Next.js 15 Turbopack Wallet Adapter example app"
  #   needs: [check-version, typecheck]
  #   uses: ./.github/workflows/test-example-app-playwright.yml
  #   with:
  #     project-path: packages/civic-auth-web3/solana/next15-wallet-adapter
  #     playwright-spec: "playwright/tests/civic-auth-web3/login/solana-next15-turbopack-wa-login.spec.ts"
  #     build-command: "yarn build"
  #     dev-command: "yarn start"
  #     job-name: "üåê Solana Next.js 15 Turbopack WA (Login)"
  #     workflow-identifier: "start-mode"
  #     allure-parent-suite: "Web3 Start Mode"
  #   secrets: inherit

  job-solana-vite-wa-example-app:
    name: "Solana Vite Wallet Adapter example app"
    needs: [check-version, typecheck]
    uses: ./.github/workflows/test-example-app-playwright.yml
    with:
      project-path: packages/civic-auth-web3/solana/vite-wallet-adapter
      playwright-spec: "playwright/tests/civic-auth-web3/login/solana-vite-wa-login.spec.ts"
      dev-command: "yarn start"
      job-name: "üåê Solana Vite WA (Login)"
      workflow-identifier: "start-mode"
      allure-parent-suite: "Web3 Start Mode"
    secrets: inherit

  job-wagmi-example-app:
    name: "Wagmi example app"
    needs: [check-version, typecheck]
    uses: ./.github/workflows/test-example-app-playwright.yml
    with:
      project-path: packages/civic-auth-web3/wagmi
      playwright-spec: "playwright/tests/civic-auth-web3/login/wagmi-login.spec.ts"
      dev-command: "yarn start"
      job-name: "üåê Wagmi (Login)"
      workflow-identifier: "start-mode"
      allure-parent-suite: "Web3 Start Mode"
    secrets: inherit

  job-wagmi-nextjs-example-app:
    name: "Wagmi Next.js example app"
    needs: [check-version, typecheck]
    uses: ./.github/workflows/test-example-app-playwright.yml
    with:
      project-path: packages/civic-auth-web3/wagmi-nextjs
      playwright-spec: "playwright/tests/civic-auth-web3/login/wagmi-nextjs-login.spec.ts"
      dev-command: "yarn start"
      job-name: "üåê Wagmi Next.js (Login)"
      workflow-identifier: "start-mode"
      allure-parent-suite: "Web3 Start Mode"
    secrets: inherit

  upload-to-allure-testops:
    name: "Upload Web3 Start Mode Results to Allure TestOps"
    needs: [
      job-solana-next14-no-wa-example-app,
      job-solana-next15-no-wa-example-app,
      # job-solana-next15-turbopack-no-wa-example-app, # Skipped - see comment above
      job-solana-vite-no-wa-example-app,
      job-solana-next14-wa-example-app,
      job-solana-next15-wa-example-app,
      # job-solana-next15-turbopack-wa-example-app, # Skipped - see comment above
      job-solana-vite-wa-example-app,
      job-wagmi-example-app,
      job-wagmi-nextjs-example-app,
    ]
    
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: read
      actions: read
    steps:
      - name: Download Allure Results
        uses: actions/download-artifact@v4
        with:
          pattern: allure-results-*
          merge-multiple: true
          path: allure-results

      - name: Upload to Allure TestOps
        if: always()
        uses: allure-framework/setup-allurectl@v1
        with:
          allure-endpoint: ${{ secrets.ALLURE_TESTOPS_ENDPOINT }}
          allure-token: ${{ secrets.ALLURE_TESTOPS_TOKEN }}
          allure-project-id: ${{ secrets.ALLURE_TESTOPS_PROJECT_ID }}
      
      - name: Upload and close launch
        if: always()
        run: |
          LAUNCH_ID=$(allurectl upload allure-results \
            --launch-name "Web3 Start Mode - Run #${{ github.run_number }}" \
            --launch-tags "web3" "start-mode" "github-actions" | grep -oP 'launch/\K[0-9]+' || echo "")
          
          if [ -n "$LAUNCH_ID" ]; then
            echo "Closing launch ID: $LAUNCH_ID"
            allurectl launch close $LAUNCH_ID
          else
            echo "Warning: Could not extract launch ID"
          fi
