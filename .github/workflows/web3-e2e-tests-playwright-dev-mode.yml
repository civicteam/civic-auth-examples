name: Civic Auth Web3 Example Apps - E2E Tests (Dev Mode)

on:
  # Temporarily disabled - uncomment to re-enable
  # schedule:
  #   - cron: '0 0 * * *'  # Run daily at midnight UTC
  # push:
  # pull_request:
  workflow_dispatch:
    inputs:
      publish-allure-to-pages:
        description: 'Publish Allure reports to GitHub Pages'
        required: false
        default: false
        type: boolean
    
jobs:
  check-version:
    uses: ./.github/workflows/check-versions.yml

  typecheck:
    uses: ./.github/workflows/typecheck.yml

  job-solana-next14-no-wa-example-app:
    name: "Solana Next.js 14 No Wallet Adapter example app"
    needs: [check-version, typecheck]
    uses: ./.github/workflows/test-example-app-playwright.yml
    with:
      project-path: packages/civic-auth-web3/solana/next14-no-wallet-adapter
      playwright-spec: "playwright/tests/civic-auth-web3/login/solana-next14-no-wa-login.spec.ts playwright/tests/civic-auth-web3/email/solana-next14-no-wa-email-verification.spec.ts"
      job-name: "üåê Solana Next.js 14 No WA (Login + Email)"
      workflow-identifier: "dev-mode"
      allure-parent-suite: "Web3 Dev Mode"
    secrets: inherit

  job-solana-next15-no-wa-example-app:
    name: "Solana Next.js 15 No Wallet Adapter example app"
    needs: [check-version, typecheck]
    uses: ./.github/workflows/test-example-app-playwright.yml
    with:
      project-path: packages/civic-auth-web3/solana/next15-no-wallet-adapter
      playwright-spec: "playwright/tests/civic-auth-web3/login/solana-next15-no-wa-login.spec.ts playwright/tests/civic-auth-web3/email/solana-next15-no-wa-email-verification.spec.ts"
      job-name: "üåê Solana Next.js 15 No WA (Login + Email)"
      workflow-identifier: "dev-mode"
      allure-parent-suite: "Web3 Dev Mode"
    secrets: inherit

  job-solana-next15-turbopack-no-wa-example-app:
    name: "Solana Next.js 15 Turbopack No Wallet Adapter example app"
    needs: [check-version, typecheck]
    uses: ./.github/workflows/test-example-app-playwright.yml
    with:
      project-path: packages/civic-auth-web3/solana/next15-no-wallet-adapter
      playwright-spec: "playwright/tests/civic-auth-web3/login/solana-next15-turbopack-no-wa-login.spec.ts playwright/tests/civic-auth-web3/email/solana-next15-turbopack-no-wa-email-verification.spec.ts"
      build-command: "yarn build"
      dev-command: "yarn dev-turbopack"
      job-name: "üåê Solana Next.js 15 Turbopack No WA (Login + Email)"
      workflow-identifier: "dev-mode"
      allure-parent-suite: "Web3 Dev Mode"
    secrets: inherit
        
  job-solana-vite-no-wa-example-app:
    name: "Solana Vite No Wallet Adapter example app"
    needs: [check-version, typecheck]
    uses: ./.github/workflows/test-example-app-playwright.yml
    with:
      project-path: packages/civic-auth-web3/solana/vite-no-wallet-adapter
      playwright-spec: "playwright/tests/civic-auth-web3/login/solana-vite-no-wa-login.spec.ts playwright/tests/civic-auth-web3/email/solana-vite-no-wa-email-verification.spec.ts"
      job-name: "üåê Solana Vite No WA (Login + Email)"
      workflow-identifier: "dev-mode"
      allure-parent-suite: "Web3 Dev Mode"
    secrets: inherit

  job-solana-next14-wa-example-app:
    name: "Solana Next.js 14 Wallet Adapter example app"
    needs: [check-version, typecheck]
    uses: ./.github/workflows/test-example-app-playwright.yml
    with:
      project-path: packages/civic-auth-web3/solana/next14-wallet-adapter
      playwright-spec: "playwright/tests/civic-auth-web3/login/solana-next14-wa-login.spec.ts playwright/tests/civic-auth-web3/email/solana-next14-wa-email-verification.spec.ts"
      job-name: "üåê Solana Next.js 14 WA (Login + Email)"
      workflow-identifier: "dev-mode"
      allure-parent-suite: "Web3 Dev Mode"
    secrets: inherit

  job-solana-next15-wa-example-app:
    name: "Solana Next.js 15 Wallet Adapter example app"
    needs: [check-version, typecheck]
    uses: ./.github/workflows/test-example-app-playwright.yml
    with:
      project-path: packages/civic-auth-web3/solana/next15-wallet-adapter
      playwright-spec: "playwright/tests/civic-auth-web3/login/solana-next15-wa-login.spec.ts playwright/tests/civic-auth-web3/email/solana-next15-wa-email-verification.spec.ts"
      job-name: "üåê Solana Next.js 15 WA (Login + Email)"
      workflow-identifier: "dev-mode"
      allure-parent-suite: "Web3 Dev Mode"
    secrets: inherit

  job-solana-next15-turbopack-wa-example-app:
    name: "Solana Next.js 15 Turbopack Wallet Adapter example app"
    needs: [check-version, typecheck]
    uses: ./.github/workflows/test-example-app-playwright.yml
    with:
      project-path: packages/civic-auth-web3/solana/next15-wallet-adapter
      playwright-spec: "playwright/tests/civic-auth-web3/login/solana-next15-turbopack-wa-login.spec.ts playwright/tests/civic-auth-web3/email/solana-next15-turbopack-wa-email-verification.spec.ts"
      build-command: "yarn build-turbopack"
      dev-command: "yarn dev-turbopack"
      job-name: "üåê Solana Next.js 15 Turbopack WA (Login + Email)"
      workflow-identifier: "dev-mode"
      allure-parent-suite: "Web3 Dev Mode"
    secrets: inherit

  job-solana-vite-wa-example-app:
    name: "Solana Vite Wallet Adapter example app"
    needs: [check-version, typecheck]
    uses: ./.github/workflows/test-example-app-playwright.yml
    with:
      project-path: packages/civic-auth-web3/solana/vite-wallet-adapter
      playwright-spec: "playwright/tests/civic-auth-web3/login/solana-vite-wa-login.spec.ts playwright/tests/civic-auth-web3/email/solana-vite-wa-email-verification.spec.ts"
      job-name: "üåê Solana Vite WA (Login + Email)"
      workflow-identifier: "dev-mode"
      allure-parent-suite: "Web3 Dev Mode"
    secrets: inherit

  job-wagmi-example-app:
    name: "Wagmi example app"
    needs: [check-version, typecheck]
    uses: ./.github/workflows/test-example-app-playwright.yml
    with:
      project-path: packages/civic-auth-web3/wagmi
      playwright-spec: "playwright/tests/civic-auth-web3/login/wagmi-login.spec.ts playwright/tests/civic-auth-web3/email/wagmi-email-verification.spec.ts"
      job-name: "üåê Wagmi (Login + Email)"
      workflow-identifier: "dev-mode"
      allure-parent-suite: "Web3 Dev Mode"
    secrets: inherit

  job-wagmi-nextjs-example-app:
    name: "Wagmi Next.js example app"
    needs: [check-version, typecheck]
    uses: ./.github/workflows/test-example-app-playwright.yml
    with:
      project-path: packages/civic-auth-web3/wagmi-nextjs
      playwright-spec: "playwright/tests/civic-auth-web3/login/wagmi-nextjs-login.spec.ts playwright/tests/civic-auth-web3/email/wagmi-nextjs-email-verification.spec.ts"
      job-name: "üåê Wagmi Next.js (Login + Email)"
      workflow-identifier: "dev-mode"
      allure-parent-suite: "Web3 Dev Mode"
    secrets: inherit

  build-allure-report:
    name: "Build Web3 Dev Mode Allure Report"
    needs: [
      job-solana-next14-no-wa-example-app,
      job-solana-next15-no-wa-example-app,
      job-solana-next15-turbopack-no-wa-example-app,
      job-solana-vite-no-wa-example-app,
      job-solana-next14-wa-example-app,
      job-solana-next15-wa-example-app,
      job-solana-next15-turbopack-wa-example-app,
      job-solana-vite-wa-example-app,
      job-wagmi-example-app,
      job-wagmi-nextjs-example-app,
    ]
    
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: read
      actions: read
    steps:
      - name: Download Allure Results
        uses: actions/download-artifact@v4
        with:
          pattern: allure-results-*
          merge-multiple: true
          path: allure-results

      - name: Load test report history
        if: always()
        continue-on-error: true
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Copy existing history to test results
        if: always()
        run: |
          echo "Copying existing history to test results directory..."
          if [ -d "gh-pages/history" ]; then
            echo "Found history in gh-pages/history"
            cp -r gh-pages/history allure-results/
            echo "History copied successfully"
          else
            echo "No existing history found, will create new"
            mkdir -p allure-results/history
          fi

      - name: Build test report (but don't publish)
        if: always()
        uses: simple-elf/allure-report-action@v1.7
        with:
          allure_results: allure-results
          allure_history: allure-history
          keep_reports: 5

      - name: Upload built report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: web3-dev-mode-allure-report
          path: allure-history
          retention-days: 5