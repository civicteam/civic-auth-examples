name: Civic Auth Example Apps - E2E Tests (Start Mode)

on:
  schedule:
    - cron: '0 1 * * *'  # Run daily at midnight UTC
  workflow_dispatch:
    
jobs:
  check-version:
    uses: ./.github/workflows/check-versions.yml

  typecheck:
    uses: ./.github/workflows/typecheck.yml

  job-nextjs-example-app:
    name: "NextJS example app"
    needs: [check-version, typecheck]
    uses: ./.github/workflows/test-example-app-playwright.yml
    with:
      project-path: packages/civic-auth/nextjs
      playwright-spec: "playwright/tests/civic-auth/login/nextjs-login.spec.ts playwright/tests/civic-auth/email/nextjs-email-verification.spec.ts playwright/tests/civic-auth/refresh/nextjs-refresh-token.spec.ts playwright/tests/civic-auth/staleSession/nextjs-stale-session.spec.ts playwright/tests/civic-auth/rehydration/nextjs-session-rehydration.spec.ts playwright/tests/civic-auth/onSignIn/nextjs-onsignin-callback.spec.ts"
      dev-command: "yarn start"
      job-name: "ðŸš€ NextJS App (Login + Email + Refresh + Stale Session + Rehydration + OnSignIn)"
      workflow-identifier: "start-mode"
      allure-parent-suite: "Web2 Start Mode"
    secrets: inherit

  # disabled because of basepath bug https://civicteam.atlassian.net/browse/TECH-2609
  # job-nextjs-basepath-example-app:
  #   name: "NextJS basepath example app"
  #   needs: check-version
  #   uses: ./.github/workflows/test-example-app-playwright.yml
  #   with:
  #     project-path: packages/civic-auth/nextjs
  #     playwright-spec: "playwright/tests/civic-auth/basePath/nextjs-login.spec.ts"
  #     build-command: "yarn build"
  #     dev-command: "yarn start:subpath"
  #     browser: webkit
  #     job-name: "ðŸš€ NextJS App (Basepath)"
  #   secrets: inherit

  # disabled because of loginSuccessUrl bug https://civicteam.atlassian.net/browse/TECH-2610
  # job-nextjs-loginsuccessurl-example-app:
  #   name: "NextJS loginSuccessUrl example app"
  #   needs: check-version
  #   uses: ./.github/workflows/test-example-app-playwright.yml
  #   with:
  #     project-path: packages/civic-auth/nextjs
  #     playwright-spec: "playwright/tests/civic-auth/loginSuccessUrl/nextjs-login.spec.ts"
  #     build-command: "yarn build"
  #     dev-command: "yarn start:loginSuccessUrl"
  #     browser: webkit
  #     job-name: "ðŸš€ NextJS App (LoginSuccessUrl)"
  #   secrets: inherit

  job-express-loginsuccessurl-example-app:
    name: "Express loginSuccessUrl example app"
    needs: [check-version, typecheck]
    uses: ./.github/workflows/test-example-app-playwright.yml
    with:
      project-path: packages/civic-auth/server/express
      playwright-spec: "playwright/tests/civic-auth/loginSuccessUrl/express-login.spec.ts"
      build-command: "yarn build"
      dev-command: "yarn start:loginSuccessUrl"
      job-name: "ðŸ› ï¸ Express Server (LoginSuccessUrl)"
      workflow-identifier: "start-mode"
      allure-parent-suite: "Web2 Start Mode"
    secrets: inherit

  job-fastify-loginsuccessurl-example-app:
    name: "Fastify loginSuccessUrl example app"
    needs: [check-version, typecheck]
    uses: ./.github/workflows/test-example-app-playwright.yml
    with:
      project-path: packages/civic-auth/server/fastify
      playwright-spec: "playwright/tests/civic-auth/loginSuccessUrl/fastify-login.spec.ts"
      build-command: "yarn build"
      dev-command: "yarn start:loginSuccessUrl"
      job-name: "âš¡ Fastify Server (LoginSuccessUrl)"
      workflow-identifier: "start-mode"
      allure-parent-suite: "Web2 Start Mode"
    secrets: inherit

  job-hono-loginsuccessurl-example-app:
    name: "Hono loginSuccessUrl example app"
    needs: [check-version, typecheck]
    uses: ./.github/workflows/test-example-app-playwright.yml
    with:
      project-path: packages/civic-auth/server/hono
      playwright-spec: "playwright/tests/civic-auth/loginSuccessUrl/hono-login.spec.ts"
      build-command: "yarn build"
      dev-command: "yarn start:loginSuccessUrl"
      job-name: "ðŸ”¥ Hono Server (LoginSuccessUrl)"
      workflow-identifier: "start-mode"
      allure-parent-suite: "Web2 Start Mode"
    secrets: inherit

  job-reactjs-example-app:
    name: "ReactJS example app"
    needs: [check-version, typecheck]
    uses: ./.github/workflows/test-example-app-playwright.yml
    with:
      project-path: packages/civic-auth/reactjs
      playwright-spec: "playwright/tests/civic-auth/login/reactjs-login.spec.ts playwright/tests/civic-auth/onSignIn/reactjs-onsignin-callback.spec.ts"
      dev-command: "yarn start"
      job-name: "âš›ï¸ ReactJS App (Login + OnSignIn)"
      workflow-identifier: "start-mode"
      allure-parent-suite: "Web2 Start Mode"
    secrets: inherit

  job-express-example-app:
    name: "Express example app"
    needs: [check-version, typecheck]
    uses: ./.github/workflows/test-example-app-playwright.yml
    with:
      project-path: packages/civic-auth/server/express
      playwright-spec: "playwright/tests/civic-auth/login/express-login.spec.ts"
      dev-command: "yarn start"
      job-name: "ðŸ› ï¸ Express Server (Login)"
      workflow-identifier: "start-mode"
      allure-parent-suite: "Web2 Start Mode"
    secrets: inherit

  job-fastify-example-app:
    name: "Fastify example app"
    needs: [check-version, typecheck]
    uses: ./.github/workflows/test-example-app-playwright.yml
    with:
      project-path: packages/civic-auth/server/fastify
      playwright-spec: "playwright/tests/civic-auth/login/fastify-login.spec.ts"
      dev-command: "yarn start"
      job-name: "âš¡ Fastify Server (Login)"
      workflow-identifier: "start-mode"
      allure-parent-suite: "Web2 Start Mode"
    secrets: inherit

  job-hono-example-app:
    name: "Hono example app"
    needs: [check-version, typecheck]
    uses: ./.github/workflows/test-example-app-playwright.yml
    with:
      project-path: packages/civic-auth/server/hono
      playwright-spec: "playwright/tests/civic-auth/login/hono-login.spec.ts"
      dev-command: "yarn start"
      job-name: "ðŸ”¥ Hono Server (Login)"
      workflow-identifier: "start-mode"
      allure-parent-suite: "Web2 Start Mode"
    secrets: inherit

  job-vanillajs-example-app:
    name: "VanillaJS example app"
    needs: [check-version, typecheck]
    uses: ./.github/workflows/test-example-app-playwright.yml
    with:
      project-path: packages/civic-auth/vanillajs
      playwright-spec: "playwright/tests/civic-auth/login/vanillajs-login.spec.ts playwright/tests/civic-auth/refresh/vanillajs-refresh-token.spec.ts playwright/tests/civic-auth/staleSession/vanillajs-stale-session.spec.ts playwright/tests/civic-auth/rehydration/vanillajs-session-rehydration.spec.ts"
      dev-command: "yarn start"
      job-name: "ðŸ“¦ VanillaJS App (Login + Refresh + Stale Session + Rehydration)"
      workflow-identifier: "start-mode"
      allure-parent-suite: "Web2 Start Mode"
    secrets: inherit

  job-vanillajs-modal-example-app:
    name: "VanillaJS Modal example app"
    needs: [check-version, typecheck]
    uses: ./.github/workflows/test-example-app-playwright.yml
    with:
      project-path: packages/civic-auth/vanillajs
      playwright-spec: "playwright/tests/civic-auth/login/vanillajs-modal-login.spec.ts playwright/tests/civic-auth/refresh/vanillajs-modal-refresh-token.spec.ts"
      job-name: "ðŸ“¦ VanillaJS Modal App (Login + Refresh)"
      workflow-identifier: "start-mode"
      allure-parent-suite: "Web2 Start Mode"
    secrets: inherit



  upload-to-allure-testops:
    name: "Upload Web2 Start Mode Results to Allure TestOps"
    needs: [
      job-nextjs-example-app,
      # job-nextjs-basepath-example-app,
      # job-nextjs-loginsuccessurl-example-app,
      job-express-loginsuccessurl-example-app,
      job-fastify-loginsuccessurl-example-app,
      job-hono-loginsuccessurl-example-app,
      job-reactjs-example-app,
      job-express-example-app,
      job-fastify-example-app,
      job-hono-example-app,
      job-vanillajs-example-app,
      job-vanillajs-modal-example-app,
    ]
    
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: read
      actions: read
    steps:
      - name: Download Allure Results
        uses: actions/download-artifact@v4
        with:
          pattern: allure-results-*
          merge-multiple: true
          path: allure-results

      - name: Download Test Results (screenshots/videos)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          pattern: test-results-*
          merge-multiple: true
          path: test-results

      - name: Merge test-results into allure-results
        if: always()
        run: |
          if [ -d "test-results" ]; then
            cp -r test-results/* allure-results/ 2>/dev/null || true
          fi

      - name: Upload to Allure TestOps
        if: always()
        uses: allure-framework/setup-allurectl@v1
        with:
          allure-endpoint: ${{ secrets.ALLURE_TESTOPS_ENDPOINT }}
          allure-token: ${{ secrets.ALLURE_TESTOPS_TOKEN }}
          allure-project-id: ${{ secrets.ALLURE_TESTOPS_PROJECT_ID }}
      
      - name: Upload test results
        if: always()
        run: |
          allurectl upload allure-results \
            --launch-name "Web2 Start Mode - Run #${{ github.run_number }}" \
            --launch-tags "web2" "start-mode" "github-actions"

