name: Test Example Apps with Safari Browser (WebKit)

on:
  workflow_call:
    inputs:
      project-path:
        required: true
        type: string
      playwright-spec:
        required: true
        type: string
      build-command:
        required: false
        type: string
        default: yarn build
      browser:
        required: false
        type: string
        default: webkit
    secrets:
      CLIENT_ID:
        required: true
      AUTH_SERVER:
        required: true
      NEXT_PUBLIC_WALLET_API_BASE_URL:
        required: true
      VITE_WALLET_API_BASE_URL:
        required: true

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      id-token: write
    env:
      CLIENT_ID: ${{ secrets.CLIENT_ID }}
      VITE_CLIENT_ID: ${{ secrets.CLIENT_ID }}
      AUTH_SERVER: ${{ secrets.AUTH_SERVER }}
      VITE_AUTH_SERVER: ${{ secrets.AUTH_SERVER }}
      NEXT_PUBLIC_WALLET_API_BASE_URL: ${{ secrets.NEXT_PUBLIC_WALLET_API_BASE_URL }}
      VITE_WALLET_API_BASE_URL: ${{ secrets.VITE_WALLET_API_BASE_URL }}
    defaults:
      run:
        working-directory: ${{ inputs.project-path }}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ github.token }}

      - name: Install Bun
        if: contains(inputs.project-path, 'hono')
        run: |
          curl -fsSL https://bun.sh/install | bash
          echo "BUN_INSTALL=$HOME/.bun" >> $GITHUB_ENV
          echo "$HOME/.bun/bin" >> $GITHUB_PATH

      - name: Cache Yarn packages
        uses: actions/cache@v4
        with:
          path: |
            ${{ inputs.project-path }}/node_modules
            packages/e2e/node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles(format('{0}/yarn.lock', inputs.project-path)) }}-${{ hashFiles(format('{0}/package.json', inputs.project-path)) }}-${{ hashFiles('packages/e2e/package.json') }}

      - name: Yarn install with latest Civic packages
        run: |
          # Function to get latest version (comparing stable vs beta)
          get_latest_version() {
            local pkg=$1
            local beta_version=$(npm view ${pkg}@beta version 2>/dev/null || echo "0.0.0")
            local stable_version=$(npm view ${pkg} version 2>/dev/null || echo "0.0.0")
            local beta_base=$(echo $beta_version | sed 's/-beta.*//')
            
            # Use beta if its base version is higher than stable
            if [[ $(echo -e "$beta_base\n$stable_version" | sort -V | tail -n 1) == "$beta_base" && "$beta_base" != "$stable_version" ]]; then
              echo "${pkg}@${beta_version}"
            else
              echo "${pkg}@${stable_version}"
            fi
          }
          
          # Check which Civic packages are dependencies and install latest versions
          if grep -q '"@civic/auth"' package.json; then
            auth_pkg=$(get_latest_version "@civic/auth")
            echo "Installing $auth_pkg"
            yarn add "$auth_pkg"
          fi
          
          if grep -q '"@civic/auth-web3"' package.json; then
            web3_pkg=$(get_latest_version "@civic/auth-web3")
            echo "Installing $web3_pkg"
            yarn add "$web3_pkg"
          fi
          
          # Install remaining dependencies
          yarn install

      - name: Install Playwright CLI and Allure
        working-directory: packages/e2e
        run: |
          yarn add -D @playwright/test allure-commandline allure-playwright
          yarn install
          
      - name: Verify Allure Installation
        working-directory: packages/e2e
        run: |
          npx allure --version
          echo "Allure command-line tool is available"

      - name: Install Playwright browsers
        working-directory: packages/e2e
        run: yarn playwright install --with-deps

      - name: Yarn build
        run: yarn build

      - name: Start App
        run: yarn dev &

      - name: Wait for app to start
        run: npx wait-on http-get://localhost:3000 --timeout 300000

      - name: Run Playwright Tests
        working-directory: packages/e2e
        env:
          ALLURE_RESULTS_DIR: allure-results
        run: yarn playwright test ${{ inputs.playwright-spec }} --project=${{ inputs.browser }}

      - name: Generate Allure Report
        if: always()
        working-directory: packages/e2e
        run: |
          echo "Checking if allure-results directory exists..."
          ls -la allure-results/ || echo "No allure-results directory found"
          echo "Generating Allure report..."
          yarn allure:generate || echo "Failed to generate Allure report"
          echo "Checking if allure-report directory was created..."
          ls -la allure-report/ || echo "No allure-report directory found"

      - name: Create Report Index
        if: always()
        working-directory: packages/e2e
        run: |
          cat > allure-report/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>Allure Test Reports</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; }
                  .header { background: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
                  .job { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
                  .job h3 { margin-top: 0; color: #333; }
                  .info { color: #666; font-size: 14px; margin-bottom: 15px; }
                  .download { background: #007cba; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px; display: inline-block; margin: 5px; }
                  .download:hover { background: #005a87; }
                  .timestamp { color: #999; font-size: 12px; }
              </style>
          </head>
          <body>
              <div class="header">
                  <h1>ðŸŽ¬ Allure Test Reports</h1>
                  <p>Download and extract these artifacts to view the detailed test reports with videos and screenshots.</p>
                  <p class="timestamp">Generated: $(date)</p>
              </div>
              
              <div class="job">
                  <h3>ðŸ“Š Allure HTML Report</h3>
                  <div class="info">
                      <strong>Job:</strong> ${{ github.job }}<br>
                      <strong>Browser:</strong> ${{ inputs.browser }}<br>
                      <strong>Run:</strong> ${{ github.run_number }}
                  </div>
                  <p>Complete HTML report with interactive features, screenshots, and video attachments.</p>
                  <a href="#" class="download">ðŸ“¥ Download Allure Report</a>
              </div>
              
              <div class="job">
                  <h3>ðŸŽ¬ Test Videos & Screenshots</h3>
                  <div class="info">
                      <strong>Job:</strong> ${{ github.job }}<br>
                      <strong>Browser:</strong> ${{ inputs.browser }}<br>
                      <strong>Run:</strong> ${{ github.run_number }}
                  </div>
                  <p>Raw test results including WebM videos, PNG screenshots, and trace files for debugging.</p>
                  <a href="#" class="download">ðŸ“¥ Download Test Results</a>
              </div>
              
              <div class="job">
                  <h3>ðŸ“‹ How to View Reports</h3>
                  <ol>
                      <li><strong>Download</strong> the "Allure Report" artifact</li>
                      <li><strong>Extract</strong> the ZIP file to a folder</li>
                      <li><strong>Open</strong> <code>index.html</code> in your browser</li>
                      <li><strong>Navigate</strong> to failed tests to see videos and screenshots</li>
                  </ol>
                  <p><em>Note: Videos are only recorded for failed tests to save storage space.</em></p>
              </div>
          </body>
          </html>
          EOF

      - name: Upload Allure Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-${{ github.job }}-${{ inputs.browser }}-${{ github.run_number }}
          path: packages/e2e/allure-report/
          retention-days: 30

      - name: Upload Allure Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-${{ github.job }}-${{ inputs.browser }}-${{ github.run_number }}
          path: packages/e2e/allure-results/
          retention-days: 30

      - name: Upload Test Results (Videos, Screenshots, Traces)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.job }}-${{ inputs.browser }}-${{ github.run_number }}
          path: packages/e2e/test-results/
          retention-days: 30 