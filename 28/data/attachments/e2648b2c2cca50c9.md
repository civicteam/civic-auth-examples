# Test info

- Name: Civic Auth Applications >> should complete full login and logout flow with custom loginSuccessUrl
- Location: /__w/civic-auth-examples/civic-auth-examples/packages/e2e/playwright/tests/civic-auth/loginSuccessUrl/nextjs-login.spec.ts:10:7

# Error details

```
Error: expect(received).toContain(expected) // indexOf

Expected substring: "/customSuccessRoute"
Received string:    "http://localhost:3000/"
    at /__w/civic-auth-examples/civic-auth-examples/packages/e2e/playwright/tests/civic-auth/loginSuccessUrl/nextjs-login.spec.ts:44:30
```

# Page snapshot

```yaml
- main:
  - text: Hello f86ab2ea-1d57-47d4-9ccc-015d40bdfe5a@example.example
  - heading "Civic Auth (NextJS)" [level=1]
  - button "Ghost":
    - text: Ghost
    - img
- alert
```

# Test source

```ts
   1 | import { test, expect } from '@playwright/test';
   2 | import { allure } from 'allure-playwright';
   3 |
   4 | test.describe('Civic Auth Applications', () => {
   5 |   test.beforeEach(async ({ page }) => {
   6 |     await allure.epic('Civic Auth Applications');
   7 |     await allure.suite('Login SuccessUrl');
   8 |     await allure.feature('Next.js Login (LoginSuccessUrl)');
   9 |   });
  10 |   test('should complete full login and logout flow with custom loginSuccessUrl', async ({ page, browserName }) => {
  11 |     // Open the app home page
  12 |     await page.goto('http://localhost:3000');
  13 |
  14 |     // Wait for the page to fully load with all UI elements
  15 |     await page.waitForLoadState('networkidle');
  16 |     await page.waitForLoadState('domcontentloaded');
  17 |     
  18 |     // Wait for the UserButton to be visible (the one that says "Sign in")
  19 |     await page.waitForSelector('button', { timeout: 10000 });
  20 |     
  21 |     // Click the UserButton "Sign in" button (first button, not the custom one)
  22 |     await page.locator('button').filter({ hasText: /^Sign in$/ }).click();
  23 |     
  24 |     // Wait for iframe to appear and load
  25 |     await page.waitForSelector('#civic-auth-iframe', { timeout: 30000 });
  26 |     
  27 |     // Click log in with dummy in the iframe
  28 |     const frame = page.frameLocator('#civic-auth-iframe');
  29 |     
  30 |     // Try to wait for the frame to load completely first
  31 |     await frame.locator('body').waitFor({ timeout: 30000 });
  32 |     
  33 |     // Look for the dummy button with extended timeout
  34 |     const dummyButton = frame.locator('[data-testid="civic-login-oidc-button-dummy"]');
  35 |     await dummyButton.click({ timeout: 20000 });
  36 |
  37 |     // Wait for the iframe to be gone (indicating login is complete)
  38 |     await page.waitForSelector('#civic-auth-iframe', { state: 'hidden', timeout: 20000 });
  39 |   
  40 |     // Confirm logged in state by checking for Ghost button in dropdown
  41 |     await expect(page.locator('#civic-dropdown-container').locator('button:has-text("Ghost")')).toBeVisible({ timeout: 20000 });
  42 |     
  43 |     // Verify custom loginSuccessUrl is loaded - should redirect to /customSuccessRoute
> 44 |     await expect(page.url()).toContain('/customSuccessRoute');
     |                              ^ Error: expect(received).toContain(expected) // indexOf
  45 |
  46 |     // Capture essential cookies after login
  47 |     const cookiesAfterLogin = await page.context().cookies();
  48 |     const authCookies = cookiesAfterLogin.filter(cookie => 
  49 |       cookie.name.includes('civic-auth') || 
  50 |       cookie.name.includes('access_token') || 
  51 |       cookie.name.includes('refresh_token') ||
  52 |       cookie.name.includes('id_token') ||
  53 |       cookie.name.includes('session')
  54 |     );
  55 |     
  56 |     // Verify we have essential auth cookies
  57 |     expect(authCookies.length).toBeGreaterThan(0);
  58 |
  59 |     // Click the Ghost button in dropdown
  60 |     await page.locator('#civic-dropdown-container').locator('button:has-text("Ghost")').click();
  61 |
  62 |     // Click the logout button
  63 |     await page.locator('#civic-dropdown-container').locator('button:has-text("Logout")').click();
  64 |     
  65 |     // Confirm successful logout
  66 |     await expect(page.locator('#civic-dropdown-container').locator('button:has-text("Ghost")')).not.toBeVisible();
  67 |     
  68 |     // Verify essential cookies are deleted after logout
  69 |     const cookiesAfterLogout = await page.context().cookies();
  70 |     const remainingAuthCookies = cookiesAfterLogout.filter(cookie => 
  71 |       cookie.name.includes('civic-auth') || 
  72 |       cookie.name.includes('access_token') || 
  73 |       cookie.name.includes('refresh_token') ||
  74 |       cookie.name.includes('id_token') ||
  75 |       cookie.name.includes('session')
  76 |     );
  77 |     
  78 |     // Assert that essential auth cookies have been deleted
  79 |     expect(remainingAuthCookies.length).toBe(0);
  80 |     
  81 |     // Additional verification: try to access the home route to ensure session is cleared
  82 |     await page.goto('http://localhost:3000');
  83 |     await page.waitForLoadState('networkidle');
  84 |     
  85 |     // Should be back to logged-out state (Sign In button visible, Ghost button not visible)
  86 |     await expect(page.locator('button').filter({ hasText: /^Sign in$/ })).toBeVisible({ timeout: 10000 });
  87 |     await expect(page.locator('#civic-dropdown-container').locator('button:has-text("Ghost")')).not.toBeVisible();
  88 |   });
  89 | });
  90 |
```