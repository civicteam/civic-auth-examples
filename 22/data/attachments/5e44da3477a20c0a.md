# Test info

- Name: Civic Auth Applications >> should complete full embedded email verification and logout flow
- Location: /__w/civic-auth-examples/civic-auth-examples/packages/e2e/playwright/tests/civic-auth/email/vanillajs-email-verification.spec.ts:13:7

# Error details

```
Error: browserType.launch: Target page, context or browser has been closed
Browser logs:

╔═══════════════════════════════════════════════════════════════════════════════════════════════════════════════════╗
║ Firefox is unable to launch if the $HOME folder isn't owned by the current user.                                  ║
║ Workaround: Set the HOME=/root environment variable in your GitHub Actions workflow file when running Playwright. ║
╚═══════════════════════════════════════════════════════════════════════════════════════════════════════════════════╝
Call log:
  - <launching> /ms-playwright/firefox-1482/firefox/firefox -no-remote -headless -profile /tmp/playwright_firefoxdev_profile-NG5Eaa -juggler-pipe -silent
  - <launched> pid=977
  - [pid=977][err] Running Nightly as root in a regular user's session is not supported.  ($HOME is /github/home which is owned by uid 1001.)
  - [pid=977] <process did exit: exitCode=1, signal=null>
  - [pid=977] starting temporary directories cleanup

```

# Test source

```ts
   1 | import { test, expect } from '@playwright/test';
   2 | import { allure } from 'allure-playwright';
   3 | import { db } from '../../../../utils/database';
   4 | import { generateUniqueEmail } from '../../../utils/email-generator';
   5 |
   6 | test.describe('Civic Auth Applications', () => {
   7 |   test.beforeEach(async ({ page }) => {
   8 |     await allure.epic('Civic Auth Applications');
   9 |     await allure.suite('Email');
   10 |     await allure.feature('VanillaJS Embedded Email Verification');
   11 |   });
   12 |
>  13 |   test('should complete full embedded email verification and logout flow', async ({ page, browserName }) => {
      |       ^ Error: browserType.launch: Target page, context or browser has been closed
   14 |     await allure.story('VanillaJS Embedded Email Code Verification Flow');
   15 |     await allure.severity('critical');
   16 |     await allure.tag('vanillajs-embedded-email-verification');
   17 |     
   18 |     let extractedLoginFlowId = '';
   19 |     const uniqueEmail = generateUniqueEmail();
   20 |
   21 |     // Open the app home page
   22 |     await allure.step('Navigate to VanillaJS app home page', async () => {
   23 |       await page.goto('http://localhost:3000');
   24 |     });
   25 |
   26 |     // Wait for the page to fully load with all UI elements
   27 |     await allure.step('Wait for page to load', async () => {
   28 |       await page.waitForLoadState('networkidle');
   29 |       await page.waitForLoadState('domcontentloaded');
   30 |     });
   31 |     
   32 |     // Click the sign in button using test ID
   33 |     await allure.step('Click sign in button', async () => {
   34 |       await page.locator('#loginButton').click();
   35 |     });
   36 |     
   37 |     await allure.step('Handle iframe email verification flow', async () => {
   38 |       // Chrome/Firefox use iframe flow
   39 |       // Wait for iframe to appear and load (specifically the embedded one)
   40 |       await page.waitForSelector('#authContainer #civic-auth-iframe', { timeout: 30000 });
   41 |       
   42 |       // Click log in with email in the iframe
   43 |       const frame = page.frameLocator('#authContainer #civic-auth-iframe');
   44 |       
   45 |       // Try to wait for the frame to load completely first
   46 |       await frame.locator('body').waitFor({ timeout: 30000 });
   47 |       
   48 |       // Wait for the login UI to fully load (not just the loading spinner)
   49 |       await allure.step('Wait for login UI to load', async () => {
   50 |         // Wait for the login content to appear (no more loading)
   51 |         await frame.locator('#civic-login-app-loading').waitFor({ state: 'hidden', timeout: 30000 });
   52 |         
   53 |         // Alternative: wait for any actual login elements to appear
   54 |         await frame.locator('[data-testid*="civic-login"]').first().waitFor({ timeout: 30000 });
   55 |       });
   56 |       
   57 |       // Look for the email login slot - first check if it's visible
   58 |       await allure.step('Find and click email login option', async () => {
   59 |         // Try to find the email slot component
   60 |         const emailSlot = frame.locator('[data-testid="civic-login-slot-email-comp"]');
   61 |         
   62 |         // Check if email slot exists and is visible
   63 |         const emailSlotCount = await emailSlot.count();
   64 |         console.log(`Email slot count: ${emailSlotCount}`);
   65 |         
   66 |         if (emailSlotCount === 0) {
   67 |           // Email slot not found, might need to look for email input directly
   68 |           console.log('Email slot not found, looking for email input...');
   69 |           const emailInputs = frame.locator('input[type="email"], [data-testid*="email"]');
   70 |           const inputCount = await emailInputs.count();
   71 |           console.log(`Found ${inputCount} email-related inputs`);
   72 |           
   73 |           // Log all inputs to see what's available
   74 |           const allInputs = frame.locator('input');
   75 |           const allInputCount = await allInputs.count();
   76 |           console.log(`Found ${allInputCount} total inputs`);
   77 |           
   78 |           for (let i = 0; i < Math.min(allInputCount, 5); i++) {
   79 |             const input = allInputs.nth(i);
   80 |             const type = await input.getAttribute('type');
   81 |             const testId = await input.getAttribute('data-testid');
   82 |             const placeholder = await input.getAttribute('placeholder');
   83 |             console.log(`Input ${i}: type="${type}", data-testid="${testId}", placeholder="${placeholder}"`);
   84 |           }
   85 |           
   86 |           throw new Error('Email login option not found in iframe');
   87 |         }
   88 |         
   89 |         await emailSlot.waitFor({ timeout: 30000 });
   90 |         await emailSlot.click();
   91 |       });
   92 |       
   93 |       // Enter email address
   94 |       await allure.step('Enter email address in iframe', async () => {
   95 |         const emailInput = frame.locator('[data-testid="email-input-text"]');
   96 |         await emailInput.waitFor({ timeout: 10000 });
   97 |         await emailInput.fill(uniqueEmail);
   98 |       });
   99 |       
  100 |       // Submit email form and wait for API response - use exact selector from Cypress
  101 |       await allure.step('Submit email form and intercept API call', async () => {
  102 |         // Set up the network interception BEFORE clicking submit
  103 |         const responsePromise = page.waitForResponse(
  104 |           response => {
  105 |             const url = response.url();
  106 |             const hasLoginFlowId = url.includes('loginFlowId');
  107 |             const isEmailEndpoint = url.includes('/email') && response.request().method() === 'GET' && url.includes('?');
  108 |             const isVerifyEndpoint = url.includes('/verify') || url.includes('/send-code');
  109 |             console.log(`Checking URL: ${url}, hasLoginFlowId: ${hasLoginFlowId}, isEmailEndpoint: ${isEmailEndpoint}, isVerifyEndpoint: ${isVerifyEndpoint}`);
  110 |             return hasLoginFlowId || isEmailEndpoint || isVerifyEndpoint;
  111 |           },
  112 |           { timeout: 30000 }
  113 |         );
```