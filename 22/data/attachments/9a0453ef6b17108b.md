# Test info

- Name: Civic Auth Applications >> should complete full embedded email verification and logout flow
- Location: /__w/civic-auth-examples/civic-auth-examples/packages/e2e/playwright/tests/civic-auth/email/vanillajs-email-verification.spec.ts:13:7

# Error details

```
TimeoutError: page.waitForSelector: Timeout 20000ms exceeded.
Call log:
  - waiting for locator('#civic-auth-iframe') to be hidden
    12 × locator resolved to 2 elements. Proceeding with the first one: <iframe scrolling="no" frameborder="0" seamless="seamless" id="civic-auth-iframe" allowfullscreen="true" data-testid="civic-auth-iframe-with-resizer" allow="camera; screen-wake-lock; publickey-credentials-get *; publickey-credentials-create *" src="https://auth-dev.civic.com/oauth/auth?client_id=demo-client-1&redirect_uri=http%3A%2F%2Flocalhost%3A3000%2F&response_type=code&scope=openid+profile+email+forwardedTokens+offline_access&state=eyJ1dWlkIjoiMDIxYzEzNzYtMDhlMi00ZDMxLWI3M2EtMDk3NDBhN2U2NzUwIiwiZG…></iframe>
    33 × locator resolved to 2 elements. Proceeding with the first one: <iframe scrolling="no" frameborder="0" seamless="seamless" id="civic-auth-iframe" allowfullscreen="true" data-testid="civic-auth-iframe-with-resizer" allow="camera; screen-wake-lock; publickey-credentials-get *; publickey-credentials-create *" src="https://auth-dev.civic.com/oauth/auth?client_id=demo-client-1&redirect_uri=http%3A%2F%2Flocalhost%3A3000%2F&response_type=code&scope=openid+profile+email+forwardedTokens+offline_access&state=eyJ1dWlkIjoiODIzMTY3NTYtNjM0Mi00Y2U2LThiMzAtMzkxNWY4NWFlZTIxIiwiZG…></iframe>

    at /__w/civic-auth-examples/civic-auth-examples/packages/e2e/playwright/tests/civic-auth/email/vanillajs-email-verification.spec.ts:161:18
```

# Page snapshot

```yaml
- heading "My App" [level=1]
- button "Sign In (Embedded)"
- button "Sign In (Modal)"
- button "Sign Out"
- iframe
```

# Test source

```ts
   61 |         
   62 |         // Check if email slot exists and is visible
   63 |         const emailSlotCount = await emailSlot.count();
   64 |         console.log(`Email slot count: ${emailSlotCount}`);
   65 |         
   66 |         if (emailSlotCount === 0) {
   67 |           // Email slot not found, might need to look for email input directly
   68 |           console.log('Email slot not found, looking for email input...');
   69 |           const emailInputs = frame.locator('input[type="email"], [data-testid*="email"]');
   70 |           const inputCount = await emailInputs.count();
   71 |           console.log(`Found ${inputCount} email-related inputs`);
   72 |           
   73 |           // Log all inputs to see what's available
   74 |           const allInputs = frame.locator('input');
   75 |           const allInputCount = await allInputs.count();
   76 |           console.log(`Found ${allInputCount} total inputs`);
   77 |           
   78 |           for (let i = 0; i < Math.min(allInputCount, 5); i++) {
   79 |             const input = allInputs.nth(i);
   80 |             const type = await input.getAttribute('type');
   81 |             const testId = await input.getAttribute('data-testid');
   82 |             const placeholder = await input.getAttribute('placeholder');
   83 |             console.log(`Input ${i}: type="${type}", data-testid="${testId}", placeholder="${placeholder}"`);
   84 |           }
   85 |           
   86 |           throw new Error('Email login option not found in iframe');
   87 |         }
   88 |         
   89 |         await emailSlot.waitFor({ timeout: 30000 });
   90 |         await emailSlot.click();
   91 |       });
   92 |       
   93 |       // Enter email address
   94 |       await allure.step('Enter email address in iframe', async () => {
   95 |         const emailInput = frame.locator('[data-testid="email-input-text"]');
   96 |         await emailInput.waitFor({ timeout: 10000 });
   97 |         await emailInput.fill(uniqueEmail);
   98 |       });
   99 |       
  100 |       // Submit email form and wait for API response - use exact selector from Cypress
  101 |       await allure.step('Submit email form and intercept API call', async () => {
  102 |         // Set up the network interception BEFORE clicking submit
  103 |         const responsePromise = page.waitForResponse(
  104 |           response => {
  105 |             const url = response.url();
  106 |             const hasLoginFlowId = url.includes('loginFlowId');
  107 |             const isEmailEndpoint = url.includes('/email') && response.request().method() === 'GET' && url.includes('?');
  108 |             const isVerifyEndpoint = url.includes('/verify') || url.includes('/send-code');
  109 |             console.log(`Checking URL: ${url}, hasLoginFlowId: ${hasLoginFlowId}, isEmailEndpoint: ${isEmailEndpoint}, isVerifyEndpoint: ${isVerifyEndpoint}`);
  110 |             return hasLoginFlowId || isEmailEndpoint || isVerifyEndpoint;
  111 |           },
  112 |           { timeout: 30000 }
  113 |         );
  114 |         
  115 |         const submitButton = frame.locator('button svg.lucide-arrow-right').locator('..');
  116 |         await submitButton.waitFor({ timeout: 10000 });
  117 |         await submitButton.click();
  118 |         
  119 |         // Now wait for the response
  120 |         const emailResponse = await responsePromise;
  121 |         const emailUrl = emailResponse.url();
  122 |         console.log('Email verification URL:', emailUrl);
  123 |         
  124 |         const urlParams = new URLSearchParams(emailUrl.split('?')[1]);
  125 |         let loginFlowId = urlParams.get('loginFlowId') || '';
  126 |         
  127 |         console.log('Extracted loginFlowId:', loginFlowId);
  128 |         
  129 |         if (!loginFlowId) {
  130 |           throw new Error(`No loginFlowId found in URL: ${emailUrl}`);
  131 |         }
  132 |         
  133 |         // Store loginFlowId for use in the next step
  134 |         extractedLoginFlowId = loginFlowId;
  135 |       });
  136 |       
  137 |       // Wait for and retrieve verification code from database
  138 |       await allure.step('Wait for verification code and retrieve from API', async () => {
  139 |         const loginFlowId = extractedLoginFlowId;
  140 |         
  141 |         // Wait for the code input fields to appear
  142 |         await frame.locator('[data-testid="code-input-0"]').waitFor({ timeout: 30000 });
  143 |         
  144 |         // Connect to database and retrieve the actual verification code
  145 |         await db.connect();
  146 |         const verificationCode = await db.waitForEmailCode(loginFlowId, 15, 2000); // Wait up to 30 seconds
  147 |         await db.disconnect();
  148 |         
  149 |         console.log(`Retrieved verification code: ${verificationCode} for loginFlowId: ${loginFlowId}`);
  150 |         
  151 |         // Enter each digit of the code (Cypress does this digit by digit)
  152 |         for (let i = 0; i < verificationCode.length; i++) {
  153 |           const digitInput = frame.locator(`[data-testid="code-input-${i}"]`);
  154 |           await digitInput.fill(verificationCode[i]);
  155 |         }
  156 |       });
  157 |       
  158 |       // Note: Verification automatically submits when 6th digit is entered
  159 |
  160 |       // Wait for the iframe to be gone (indicating login is complete)
> 161 |       await page.waitForSelector('#civic-auth-iframe', { state: 'hidden', timeout: 20000 });
      |                  ^ TimeoutError: page.waitForSelector: Timeout 20000ms exceeded.
  162 |     });
  163 |     
  164 |     // Confirm logged in state by checking for user info display
  165 |     await allure.step('Verify login success', async () => {
  166 |       await page.getByRole('button', { name: 'Sign Out' }).click();
  167 |       await page.getByRole('button', { name: 'Sign In' });
  168 |     });
  169 |     
  170 |     // Verify token refresh fails after logout
  171 |     await allure.step('Verify token refresh fails after logout', async () => {
  172 |       const response = await page.request.post('https://auth-dev.civic.com/oauth/token', {
  173 |         form: {
  174 |           grant_type: 'refresh_token',
  175 |           refresh_token: 'storedRefreshToken',
  176 |           client_id: process.env.CLIENT_ID || ''
  177 |         }
  178 |       });
  179 |       expect(response.status()).toBe(400);
  180 |     });
  181 |   });
  182 | });
  183 |
```