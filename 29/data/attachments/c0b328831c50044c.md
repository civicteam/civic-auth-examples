# Test info

- Name: Civic Auth Applications >> should complete email verification flow
- Location: /__w/civic-auth-examples/civic-auth-examples/packages/e2e/playwright/tests/civic-auth/email/nextjs-email-verification.spec.ts:13:7

# Error details

```
Error: page.waitForSelector: Test timeout of 30000ms exceeded.
Call log:
  - waiting for locator('[data-testid="civic-auth-iframe-with-resizer"]') to be visible
    2 × locator resolved to hidden <iframe scrolling="no" frameborder="0" seamless="seamless" id="civic-auth-iframe" allowfullscreen="true" data-testid="civic-auth-iframe-with-resizer" allow="camera; screen-wake-lock; publickey-credentials-get *; publickey-credentials-create *" src="http://localhost:3000/api/auth/login?state=eyJ1dWlkIjoiNGZhM2I1NTAtMjJmNi00NTYxLWI2OTUtMTgzYzJkYmI4OWVmIiwiZGlzcGxheU1vZGUiOiJpZnJhbWUiLCJpZnJhbWVEaXNwbGF5TW9kZSI6Im1vZGFsIiwiZnJhbWV3b3JrIjoibmV4dGpzIiwic2RrVmVyc2lvbiI6IkBjaXZpYy9hdXRoOjAuMTAuMC1iZXRhLjcifQ…></iframe>
    56 × locator resolved to 2 elements. Proceeding with the first one: <iframe scrolling="no" frameborder="0" seamless="seamless" id="civic-auth-iframe" allowfullscreen="true" data-testid="civic-auth-iframe-with-resizer" allow="camera; screen-wake-lock; publickey-credentials-get *; publickey-credentials-create *" src="http://localhost:3000/api/auth/login?state=eyJ1dWlkIjoiNGZhM2I1NTAtMjJmNi00NTYxLWI2OTUtMTgzYzJkYmI4OWVmIiwiZGlzcGxheU1vZGUiOiJpZnJhbWUiLCJpZnJhbWVEaXNwbGF5TW9kZSI6Im1vZGFsIiwiZnJhbWV3b3JrIjoibmV4dGpzIiwic2RrVmVyc2lvbiI6IkBjaXZpYy9hdXRoOjAuMTAuMC1iZXRhLjcifQ…></iframe>

    at body (/__w/civic-auth-examples/civic-auth-examples/packages/e2e/playwright/tests/civic-auth/email/nextjs-email-verification.spec.ts:38:18)
    at body (/__w/civic-auth-examples/civic-auth-examples/packages/e2e/node_modules/allure-js-commons/src/facade.ts:113:48)
    at call (/__w/civic-auth-examples/civic-auth-examples/packages/e2e/node_modules/allure-playwright/src/runtime.ts:13:56)
    at Generator._invoke (/__w/civic-auth-examples/civic-auth-examples/packages/e2e/node_modules/allure-playwright/src/runtime.ts:2:1)
    at Generator.next (/__w/civic-auth-examples/civic-auth-examples/packages/e2e/node_modules/allure-playwright/src/runtime.ts:2:1)
    at asyncGeneratorStep (/__w/civic-auth-examples/civic-auth-examples/packages/e2e/node_modules/allure-playwright/src/runtime.ts:2:1)
    at _next (/__w/civic-auth-examples/civic-auth-examples/packages/e2e/node_modules/allure-playwright/src/runtime.ts:2:1)
    at /__w/civic-auth-examples/civic-auth-examples/packages/e2e/node_modules/allure-playwright/src/runtime.ts:2:1
    at /__w/civic-auth-examples/civic-auth-examples/packages/e2e/node_modules/allure-playwright/src/runtime.ts:2:1
    at call (/__w/civic-auth-examples/civic-auth-examples/packages/e2e/node_modules/allure-playwright/src/runtime.ts:13:23)
    at Generator._invoke (/__w/civic-auth-examples/civic-auth-examples/packages/e2e/node_modules/allure-playwright/src/runtime.ts:2:1)
    at Generator.next (/__w/civic-auth-examples/civic-auth-examples/packages/e2e/node_modules/allure-playwright/src/runtime.ts:2:1)
    at asyncGeneratorStep (/__w/civic-auth-examples/civic-auth-examples/packages/e2e/node_modules/allure-playwright/src/runtime.ts:2:1)
    at _next (/__w/civic-auth-examples/civic-auth-examples/packages/e2e/node_modules/allure-playwright/src/runtime.ts:2:1)
    at /__w/civic-auth-examples/civic-auth-examples/packages/e2e/node_modules/allure-playwright/src/runtime.ts:2:1
    at AllurePlaywrightTestRuntime.apply (/__w/civic-auth-examples/civic-auth-examples/packages/e2e/node_modules/allure-playwright/src/runtime.ts:2:1)
    at AllurePlaywrightTestRuntime.step (/__w/civic-auth-examples/civic-auth-examples/packages/e2e/node_modules/allure-playwright/src/runtime.ts:12:13)
    at callRuntimeMethod (/__w/civic-auth-examples/civic-auth-examples/packages/e2e/node_modules/allure-js-commons/src/facade.ts:21:27)
    at Object.step (/__w/civic-auth-examples/civic-auth-examples/packages/e2e/node_modules/allure-js-commons/src/facade.ts:113:10)
    at Object.step (/__w/civic-auth-examples/civic-auth-examples/packages/e2e/node_modules/allure-playwright/src/legacy.ts:147:48)
    at /__w/civic-auth-examples/civic-auth-examples/packages/e2e/playwright/tests/civic-auth/email/nextjs-email-verification.spec.ts:35:18
```

# Page snapshot

```yaml
- main:
  - heading "Civic Auth (NextJS)" [level=1]
  - button "Signing in..."
  - button "Sign in (Custom)"
- button "Open Next.js Dev Tools":
  - img
- alert
- iframe
- button "Close":
  - img
```

# Test source

```ts
   1 | import { test, expect } from '@playwright/test';
   2 | import { allure } from 'allure-playwright';
   3 | import { db } from '../../../../utils/database';
   4 | import { generateUniqueEmail } from '../../../utils/email-generator';
   5 |
   6 | test.describe('Civic Auth Applications', () => {
   7 |   test.beforeEach(async ({ page }) => {
   8 |     await allure.epic('Civic Auth Applications');
   9 |     await allure.suite('Email');
   10 |     await allure.feature('Next.js Email Verification');
   11 |   });
   12 |
   13 |   test('should complete email verification flow', async ({ page, browserName }) => {
   14 |     await allure.story('Next.js Email Code Verification Flow');
   15 |     await allure.severity('critical');
   16 |     await allure.tag('nextjs-authentication-email-verification-code');
   17 |     
   18 |     let extractedLoginFlowId = '';
   19 |     const uniqueEmail = generateUniqueEmail();
   20 |
   21 |     // Open the app home page
   22 |     await allure.step('Navigate to Next.js app home page', async () => {
   23 |       await page.goto('http://localhost:3000');
   24 |     });
   25 |         
   26 |     // Wait for the page to fully load with all UI elements
   27 |     await page.waitForLoadState('networkidle');
   28 |     await page.waitForLoadState('domcontentloaded');
   29 |     
   30 |     // Click the sign in button using test ID
   31 |     await allure.step('Click sign in button', async () => {
   32 |       await page.getByTestId('sign-in-button').click();
   33 |     });
   34 |     
   35 |     await allure.step('Handle iframe email verification flow', async () => {
   36 |       // Chrome/Firefox use iframe flow
   37 |       // Wait for iframe to appear and load using the correct selector
>  38 |       await page.waitForSelector('[data-testid="civic-auth-iframe-with-resizer"]', { timeout: 30000 });
      |                  ^ Error: page.waitForSelector: Test timeout of 30000ms exceeded.
   39 |       
   40 |       // Click log in with email in the iframe
   41 |       const frame = page.frameLocator('[data-testid="civic-auth-iframe-with-resizer"]');
   42 |       
   43 |       // Try to wait for the frame to load completely first
   44 |       await frame.locator('body').waitFor({ timeout: 30000 });
   45 |       
   46 |       // Wait for the login UI to fully load (not just the loading spinner)
   47 |       await allure.step('Wait for login UI to load', async () => {
   48 |         // Wait for the login content to appear (no more loading)
   49 |         await frame.locator('#civic-login-app-loading').waitFor({ state: 'hidden', timeout: 30000 });
   50 |         
   51 |         // Alternative: wait for any actual login elements to appear
   52 |         await frame.locator('[data-testid*="civic-login"]').first().waitFor({ timeout: 30000 });
   53 |       });
   54 |       
   55 |       // Debug: Let's see what's actually in the iframe
   56 |       await allure.step('Debug iframe content', async () => {
   57 |         const bodyText = await frame.locator('body').textContent();
   58 |         console.log(`Iframe body text: "${bodyText}"`);
   59 |         
   60 |         const allElements = frame.locator('*');
   61 |         const elementCount = await allElements.count();
   62 |         console.log(`Found ${elementCount} elements in iframe`);
   63 |         
   64 |         const allButtons = frame.locator('button');
   65 |         const buttonCount = await allButtons.count();
   66 |         console.log(`Found ${buttonCount} buttons in iframe`);
   67 |         
   68 |         // If we have buttons, log their details
   69 |         for (let i = 0; i < Math.min(buttonCount, 10); i++) {
   70 |           const button = allButtons.nth(i);
   71 |           const text = await button.textContent();
   72 |           const testId = await button.getAttribute('data-testid');
   73 |           console.log(`Button ${i}: text="${text}", data-testid="${testId}"`);
   74 |         }
   75 |         
   76 |         // Also look for any divs or spans that might be clickable
   77 |         const clickableElements = frame.locator('[data-testid*="login"], [data-testid*="email"], [role="button"], .button, [class*="button"]');
   78 |         const clickableCount = await clickableElements.count();
   79 |         console.log(`Found ${clickableCount} potentially clickable elements`);
   80 |         
   81 |         for (let i = 0; i < Math.min(clickableCount, 5); i++) {
   82 |           const element = clickableElements.nth(i);
   83 |           const text = await element.textContent();
   84 |           const testId = await element.getAttribute('data-testid');
   85 |           const className = await element.getAttribute('class');
   86 |           console.log(`Clickable ${i}: text="${text}", data-testid="${testId}", class="${className}"`);
   87 |         }
   88 |       });
   89 |       
   90 |       // Look for the email login slot - first check if it's visible
   91 |       await allure.step('Find and click email login option', async () => {
   92 |         // Try to find the email slot component
   93 |         const emailSlot = frame.locator('[data-testid="civic-login-slot-email-comp"]');
   94 |         
   95 |         // Check if email slot exists and is visible
   96 |         const emailSlotCount = await emailSlot.count();
   97 |         console.log(`Email slot count: ${emailSlotCount}`);
   98 |         
   99 |         if (emailSlotCount === 0) {
  100 |           // Email slot not found, might need to look for email input directly
  101 |           console.log('Email slot not found, looking for email input...');
  102 |           const emailInputs = frame.locator('input[type="email"], [data-testid*="email"]');
  103 |           const inputCount = await emailInputs.count();
  104 |           console.log(`Found ${inputCount} email-related inputs`);
  105 |           
  106 |           // Log all inputs to see what's available
  107 |           const allInputs = frame.locator('input');
  108 |           const allInputCount = await allInputs.count();
  109 |           console.log(`Found ${allInputCount} total inputs`);
  110 |           
  111 |           for (let i = 0; i < Math.min(allInputCount, 5); i++) {
  112 |             const input = allInputs.nth(i);
  113 |             const type = await input.getAttribute('type');
  114 |             const testId = await input.getAttribute('data-testid');
  115 |             const placeholder = await input.getAttribute('placeholder');
  116 |             console.log(`Input ${i}: type="${type}", data-testid="${testId}", placeholder="${placeholder}"`);
  117 |           }
  118 |           
  119 |           throw new Error('Email login option not found in iframe');
  120 |         }
  121 |         
  122 |         await emailSlot.waitFor({ timeout: 30000 });
  123 |         await emailSlot.click();
  124 |       });
  125 |       
  126 |       // Enter email address
  127 |       await allure.step('Enter email address in iframe', async () => {
  128 |         const emailInput = frame.locator('[data-testid="email-input-text"]');
  129 |         await emailInput.waitFor({ timeout: 10000 });
  130 |         await emailInput.fill(uniqueEmail);
  131 |       });
  132 |       
  133 |       // Submit email form and wait for API response - use exact selector from Cypress
  134 |       await allure.step('Submit email form and intercept API call', async () => {
  135 |         // Set up the network interception BEFORE clicking submit
  136 |         const responsePromise = page.waitForResponse(
  137 |           response => {
  138 |             const url = response.url();
```