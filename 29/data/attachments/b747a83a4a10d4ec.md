# Test info

- Name: Civic Auth Applications >> should complete full login and logout flow
- Location: /__w/civic-auth-examples/civic-auth-examples/packages/e2e/playwright/tests/civic-auth/nextjs-login.spec.ts:10:7

# Error details

```
TimeoutError: page.waitForSelector: Timeout 30000ms exceeded.
Call log:
  - waiting for locator('#civic-auth-iframe') to be visible
    2 × locator resolved to hidden <iframe scrolling="no" frameborder="0" seamless="seamless" id="civic-auth-iframe" allowfullscreen="true" data-testid="civic-auth-iframe-with-resizer" allow="camera; screen-wake-lock; publickey-credentials-get *; publickey-credentials-create *" src="http://localhost:3000/api/auth/login?state=eyJ1dWlkIjoiMWM5NDE4MmEtZWE1MC00ZTkyLThkYTgtMjFiNzg2MDA2YTIxIiwiZGlzcGxheU1vZGUiOiJpZnJhbWUiLCJpZnJhbWVEaXNwbGF5TW9kZSI6Im1vZGFsIiwiZnJhbWV3b3JrIjoibmV4dGpzIiwic2RrVmVyc2lvbiI6IkBjaXZpYy9hdXRoOjAuMTAuMC1iZXRhLjcifQ…></iframe>
    59 × locator resolved to 2 elements. Proceeding with the first one: <iframe scrolling="no" frameborder="0" seamless="seamless" id="civic-auth-iframe" allowfullscreen="true" data-testid="civic-auth-iframe-with-resizer" allow="camera; screen-wake-lock; publickey-credentials-get *; publickey-credentials-create *" src="http://localhost:3000/api/auth/login?state=eyJ1dWlkIjoiMWM5NDE4MmEtZWE1MC00ZTkyLThkYTgtMjFiNzg2MDA2YTIxIiwiZGlzcGxheU1vZGUiOiJpZnJhbWUiLCJpZnJhbWVEaXNwbGF5TW9kZSI6Im1vZGFsIiwiZnJhbWV3b3JrIjoibmV4dGpzIiwic2RrVmVyc2lvbiI6IkBjaXZpYy9hdXRoOjAuMTAuMC1iZXRhLjcifQ…></iframe>

    at /__w/civic-auth-examples/civic-auth-examples/packages/e2e/playwright/tests/civic-auth/nextjs-login.spec.ts:28:16
```

# Page snapshot

```yaml
- main:
  - heading "Civic Auth (NextJS)" [level=1]
  - button "Signing in..."
  - button "Sign in (Custom)"
- button "Open Next.js Dev Tools":
  - img
- alert
- iframe
- button "Close":
  - img
```

# Test source

```ts
   1 | import { test, expect } from '@playwright/test';
   2 | import { allure } from 'allure-playwright';
   3 |
   4 | test.describe('Civic Auth Applications', () => {
   5 |   test.beforeEach(async ({ page }) => {
   6 |     await allure.epic('Civic Auth Applications');
   7 |     await allure.suite('Login');
   8 |     await allure.feature('Next.js Login');
   9 |   });
   10 |   test('should complete full login and logout flow', async ({ page, browserName }) => {
   11 |     // Configure test to be more resilient
   12 |     test.setTimeout(120000); // Increase timeout to 2 minutes
   13 |
   14 |     // Open the app home page
   15 |     await page.goto('http://localhost:3000');
   16 |
   17 |     // Wait for the page to fully load with all UI elements
   18 |     await page.waitForLoadState('networkidle');
   19 |     await page.waitForLoadState('domcontentloaded');
   20 |     
   21 |     // Wait for the UserButton to be visible (the one that says "Sign in")
   22 |     await page.waitForSelector('button', { timeout: 10000 });
   23 |     
   24 |     // Click the UserButton "Sign in" button (first button, not the custom one)
   25 |     await page.locator('button').filter({ hasText: /^Sign in$/ }).click();
   26 |     
   27 |     // Wait for iframe to appear and load
>  28 |     await page.waitForSelector('#civic-auth-iframe', { timeout: 30000 });
      |                ^ TimeoutError: page.waitForSelector: Timeout 30000ms exceeded.
   29 |     
   30 |     // Click log in with dummy in the iframe
   31 |     const frame = page.frameLocator('#civic-auth-iframe');
   32 |     
   33 |     // Try to wait for the frame to load completely first
   34 |     await frame.locator('body').waitFor({ timeout: 30000 });
   35 |     
   36 |     // Wait for the login UI to fully load (not just the loading spinner)
   37 |     try {
   38 |       const loadingElement = frame.locator('#civic-login-app-loading');
   39 |       const isLoadingVisible = await loadingElement.isVisible({ timeout: 5000 }).catch(() => false);
   40 |       
   41 |       if (isLoadingVisible) {
   42 |         await loadingElement.waitFor({ state: 'hidden', timeout: 45000 });
   43 |       }
   44 |     } catch (error) {
   45 |       // Loading element might not exist, that's ok
   46 |     }
   47 |     
   48 |     // Wait for login elements to appear
   49 |     await frame.locator('[data-testid*="civic-login"]').first().waitFor({ timeout: 30000 });
   50 |     
   51 |     // Look for the dummy button with extended timeout and ensure it's visible
   52 |     const dummyButton = frame.locator('[data-testid="civic-login-oidc-button-dummy"]');
   53 |     await dummyButton.waitFor({ state: 'visible', timeout: 30000 });
   54 |     
   55 |     // Add a small delay to ensure button is fully interactive
   56 |     await page.waitForTimeout(1000);
   57 |     
   58 |     // Click the dummy button
   59 |     await dummyButton.click({ timeout: 20000 });
   60 |     
   61 |     // Wait for any loading to complete after click
   62 |     try {
   63 |       const loadingAfterClick = frame.locator('#civic-login-app-loading');
   64 |       const isLoadingVisibleAfterClick = await loadingAfterClick.isVisible({ timeout: 3000 }).catch(() => false);
   65 |       
   66 |       if (isLoadingVisibleAfterClick) {
   67 |         // Wait longer for the auth flow to complete
   68 |         await loadingAfterClick.waitFor({ state: 'hidden', timeout: 60000 });
   69 |       }
   70 |     } catch (error) {
   71 |       // Loading handling - if it fails, continue
   72 |     }
   73 |
   74 |     // Wait for the iframe to be gone (indicating login is complete)
   75 |     await page.waitForSelector('#civic-auth-iframe', { state: 'hidden', timeout: 60000 });
   76 |   
   77 |     // Confirm logged in state by checking for Ghost button in dropdown
   78 |     const ghostButtonLocator = page.locator('#civic-dropdown-container').locator('button:has-text("Ghost")');
   79 |     await expect(ghostButtonLocator).toBeVisible({ timeout: 20000 });
   80 |     
   81 |     // Verify custom loginSuccessUrl is not loaded
   82 |     await expect(page.url()).not.toContain('loginSuccessUrl');
   83 |
   84 |     // Click the Ghost button in dropdown
   85 |     const ghostButton = page.locator('#civic-dropdown-container').locator('button:has-text("Ghost")');
   86 |     await ghostButton.waitFor({ state: 'visible', timeout: 10000 });
   87 |     await ghostButton.click();
   88 |
   89 |     // Click the logout button
   90 |     const logoutButton = page.locator('#civic-dropdown-container').locator('button:has-text("Logout")');
   91 |     await logoutButton.waitFor({ state: 'visible', timeout: 10000 });
   92 |     await logoutButton.click();
   93 |     
   94 |     // Confirm successful logout
   95 |     await expect(page.locator('#civic-dropdown-container').locator('button:has-text("Ghost")')).not.toBeVisible();
   96 |     
   97 |     // Verify essential cookies are deleted after logout
   98 |     const cookiesAfterLogout = await page.context().cookies();
   99 |     const remainingAuthCookies = cookiesAfterLogout.filter(cookie => 
  100 |       cookie.name.includes('civic-auth') || 
  101 |       cookie.name.includes('access_token') || 
  102 |       cookie.name.includes('refresh_token') ||
  103 |       cookie.name.includes('id_token') ||
  104 |       cookie.name.includes('session')
  105 |     );
  106 |     
  107 |     // Assert that essential auth cookies have been deleted
  108 |     expect(remainingAuthCookies.length).toBe(0);
  109 |     
  110 |     // Additional verification: try to access a protected route to ensure session is cleared
  111 |     await page.goto('http://localhost:3000');
  112 |     await page.waitForLoadState('networkidle');
  113 |     
  114 |     // Should be back to logged-out state (Sign In button visible, Ghost button not visible)
  115 |     await expect(page.locator('button').filter({ hasText: /^Sign in$/ })).toBeVisible({ timeout: 10000 });
  116 |     await expect(page.locator('#civic-dropdown-container').locator('button:has-text("Ghost")')).not.toBeVisible();
  117 |   });
  118 | }); 
```